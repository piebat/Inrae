<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="//unpkg.com/3d-force-graph"></script>
    <script src="//unpkg.com/three"></script>
    <script src="//unpkg.com/three-spritetext"></script>
    <script src="https://unpkg.com/neo4j-driver"></script>
    <script src="https://code.jquery.com/jquery-3.5.0.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
    crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
    integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
    crossorigin=""></script>
 
  
    <title>PRIN 2020 Test</title>

  <style>
    #mapid{
      height: 800px;
    };

  </style>
</head>
<body { margin: 0; }>

    <nav class="navbar fixed-top navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
          <a class="navbar-brand" href="/one/">PRIN</a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                  Operazioni su DB
                </a>
                <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                  <li><a class="dropdown-item" href="{% url 'one:delete' %}">Pulisci Database</a></li>
                  <li><hr class="dropdown-divider"></li>
                  <li><a class="dropdown-item" onclick="popolaDb()">Popola il Database</a></li>
                </ul>
              </li>
            </ul>
            <span class="nav-item" style='color:green'> Collegamenti con minimo </span>
            <form class="d-flex">
              <input class="form-control me-2" type="text" placeholder="aziende" aria-label="Filtra">
              <button class="btn btn-outline-success" type="submit">Filtra</button> 
            </form>
          </div>
        </div>
      </nav>
<main>
    <div class="container-fluid " style="position:relative; padding-top: 60px;">
        <h1 id="titolo">{{titolo}}</h1>
        <div class=" container-fluid">
        <input type="checkbox" class="btn-check" id="btn-text" autocomplete="off" onclick="Toggle_Testo()">
        <label id="btn-toggle-testo" class="btn btn-primary" for="btn-text">Testo</label>

        <!-- <input type="checkbox" class="btn-check " id="btn-map" autocomplete="off" onclick="Toggle_Map()">
        <label id="btn-toggle-mappa" class="btn btn-primary" for="btn-map">Mappa ON</label> -->

        <hr>
        <div  class="d-flex justify-content-center">
            <div id="spinner" class="spinner-border text-success" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
        </div>
      </div>
        {% block content %}
        {% if filtro >= 0 %}
        <h5>Filtrata per <span id='filtro'>{{filtro}}</span></h5>
        {% endif %}
        {% if sll_list %}
        <h2>SLL List</h2>
        <ul>
            {% for sll in sll_list %}
            <li>
                {{ sll.code }} {{sll.name}} {{sll.lat}} {{sll.lng}}
            </li>
            {% endfor %}
        </ul>
        {% endif %} 
        {% endblock %}

        <div class="card">
          <div class="card-body">
            <div id="details" class="card-text"></div>
          </div>
        </div>

        <div id="3d-graph-xl"  style=" background-color: black;"></div>

        <div class="row g-2">
          <div class="col-6 d-inline">
            <div id="3d-graph"  style=" background-color: black;"></div>
          </div>
          <div class="col-6 d-inline">
            <div id="mapid"></div>
          </div>
        </div>

    </div>
  </main>

  <script>
  

 </script>
    <script>
      var mymap = L.map('mapid').setView([39.309993, 16.250193], 5);
      $("#spinner").hide()
      //$("#mapid").hide()
      var testo = false;
      var mappa = true;
      
      var nodes = {}
      var links = {}

      function get_MyData(myData){
        nodes = {}
        links = myData.map(r => { 
	      var source = r[0];
           nodes[source.id] = source;
	      var target = r[1];
           nodes[target.id] = target;
           var rel = r[2];
	       return Object.assign({source:source.id,target:target.id}, rel); // riformatta i record
	    })};

      get_MyData({{nodi|safe}});
      
      const gData = {nodes: Object.values(nodes), links: links} // dei nodi prendere solo i valori non gli indici
  

      // link evidenzia
        // cross-link node objects
    gData.links.forEach(link => {
     const a = nodes[link.source];
     const b = nodes[link.target];
     !a.neighbors && (a.neighbors = []);
     !b.neighbors && (b.neighbors = []);
     a.neighbors.push(b);
     b.neighbors.push(a);

     !a.links && (a.links = []);
     !b.links && (b.links = []);
     a.links.push(link);
     b.links.push(link);
   });

   const highlightNodes = new Set();
   const highlightLinks = new Set();
   let hoverNode = null;

   function updateHighlight() {
     // trigger update of highlighted objects in scene
     Graph
       .nodeColor(Graph.nodeColor())
       .linkWidth(Graph.linkWidth())
       .linkDirectionalParticles(Graph.linkDirectionalParticles());
   }
   // fine Link Evidenzia

    
      const elem = document.getElementById('3d-graph');
      const elemXl = document.getElementById('3d-graph-xl');
      var Graph = ForceGraph3D()(elem);

      function Grafo() {
        const start = new Date();
        // console.log(gData);
                  Graph
                      .graphData(gData)
                      .nodeAutoColorBy('label')
                      .nodeVal('size')
                      .linkAutoColorBy('type')
                      //.linkWidth('weight')
                      .nodeLabel(node => `${node.label}: ${node.caption}`)
                      .onNodeHover(node => elem.style.cursor = node ? 'pointer' : null)
                      .onNodeDragEnd(node => {
                        node.fx = node.x;
                        node.fy = node.y;
                        node.fz = node.z;
                      })
                      .linkThreeObjectExtend(true)
                      .linkThreeObject(link => {
                        // extend link with text sprite
                        const sprite = new SpriteText(`${link.imprese}`);
                        sprite.color = 'lightgrey';
                        sprite.textHeight = 1.5;
                        return sprite;
                      })
                      .linkPositionUpdate((sprite, { start, end }) => {
                          const middlePos = Object.assign(...['x', 'y', 'z'].map(c => ({
                          [c]: start[c] + (end[c] - start[c]) / 2 // calc middle point
                        })))
                        Object.assign(sprite.position, middlePos)
                      })
                      .onNodeClick(node => {
                          // Aim at node from outside it
                          $("#details").text(`${node.label}: ${node.caption}`);
                          const distance = 150 ;
                          const distRatio = 1 + distance/Math.hypot(node.x, node.y, node.z);
                          Graph.cameraPosition(
                            { x: node.x * distRatio, y: node.y * distRatio, z: node.z * distRatio }, // new position
                            node, // lookAt ({ x, y, z })
                            3000  // ms transition duration
                            );
                            //mymap.panTo(L.latLng(node));
                            mymap.setView(L.latLng(node), 13);
                            scroll_to("#mapid")
                        })
                        
                        //.nodeColor(node => highlightNodes.has(node) ? node === hoverNode ? 'rgb(255,0,0,1)' : 'rgba(255,160,0,0.8)' : 'rgba(0,255,255,0.6)')
                        
                        .linkWidth(link => highlightLinks.has(link) ? 4 : link['weight'])
                        .linkDirectionalParticles(link => highlightLinks.has(link) ? 4 : 0)
                        .linkDirectionalParticleWidth(4)
                        .onNodeHover(node => {
                          // no state change
                          if ((!node && !highlightNodes.size) || (node && hoverNode === node)) return;

                          highlightNodes.clear();
                          highlightLinks.clear();
                          if (node) {
                            highlightNodes.add(node);
                            node.neighbors.forEach(neighbor => highlightNodes.add(neighbor));
                            node.links.forEach(link => highlightLinks.add(link));
                          }

                          hoverNode = node || null;

                          updateHighlight();
                        })

                        .onLinkHover(link => {
                          highlightNodes.clear();
                          highlightLinks.clear();

                          if (link) {
                            highlightLinks.add(link);
                            highlightNodes.add(link.source);
                            highlightNodes.add(link.target);
                          }

                          updateHighlight();
                        });

                      Graph.d3Force('charge').strength(-120);
                      Graph.width(window.innerWidth/2);

      }
      Grafo();


      function Toggle_Testo() {
        testo = ! testo;
        if (testo) {
          $('#btn-toggle-testo').text("Sfere");
          Graph.nodeThreeObject(node => {
                        const sprite = new SpriteText(node.caption);
                        sprite.material.depthWrite = false; // make sprite background transparent
                        sprite.color = node.color;
                        sprite.textHeight = 8;
                        return sprite;
                      });
        }else {
          $('#btn-toggle-testo').text("Testo");
          Graph.nodeThreeObject(node => {
                          const sprite = new THREE.Mesh(
                            new THREE.SphereGeometry(10),
                            THREE.SphereGeometry
                        )})
        }
      }

      function Toggle_Map() {
        if (mappa) {
          $('#btn-toggle-mappa').text("Mappa ON");
          $('#mapid').hide()
          //Graph = ForceGraph3D()(elemXl);
          //Graph.width(window.width)
          //elem.innerHTML="";
          //Grafo();
        } else {
          $('#btn-toggle-mappa').text("Mappa OFF");
          $('#mapid').show()
          //scroll_to("#mapid")
        } 
        mappa = ! mappa
      }

      function scroll_to(myid){
        $('html, body').animate({
              scrollTop: $(myid).offset().top
              }, 2000);
        }

  </script>
  <script>
    function popolaDb() {
        $("#spinner").show();
        window.location.href="/one/sll/"
    }

    $( "form" ).submit(function( event ) {
     $("#spinner").show();
     fil = parseInt($( "input" ).first().val());
     if (isNaN(fil)) {
        alert("deve Essere un Intero maggiore uguale a zero")
     } else
      {
        // $( "span" ).text( fil ).show().fadeOut( 1000 );
        window.location.href= "/one/grafo/"+ fil + "/"
     } 
     event.preventDefault();
});
  </script>

<script>

  L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
    maxZoom: 18,
    id: 'mapbox/streets-v11',
    tileSize: 512,
    zoomOffset: -1,
    accessToken: 'pk.eyJ1IjoicGllYmF0IiwiYSI6ImNrbTlkNGQxeDE0bjEydm16bGw4bzF5NG0ifQ.oytwdA8i5yX6ErDHRRj-zw'
  }).addTo(mymap);
  

  for (const [k , element] of Object.entries(nodes)) {
  try {
      if (element.label=='Sll') {
      ll=L.latLng(element.lat,element.lng)
    L.marker(ll)
    .on('click', onMarkerClick)
    .addTo(mymap);
      }
    } catch
    {
      console.log(ll);
    }
  };

   function onMarkerClick(e){
   var node={};
   for (const [k , element] of Object.entries(gData.nodes)){
     if (element.label=='Sll') {
      ll= L.latLng(element.lat,element.lng);
     console.log(ll, e.latlng)
     if ( ll.equals(e.latlng)) {
       node = element;
      }
     }
   };
   const distance = 100;
   const distRatio = 1 + distance/Math.hypot(node.x, node.y, node.z);
   Graph.cameraPosition(
    { x: node.x * distRatio, y: node.y * distRatio, z: node.z * distRatio }, // new position
     node, // lookAt ({ x, y, z })
     3000  // ms transition duration
     );
     scroll_to("#3d-graph")
   };
  </script>

 
</body>
</html>